<div class="password-manager-container">
  <h2>Moj Password Manager</h2>

  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="isLoading" class="spinner-border text-primary" role="status">
    <span class="sr-only">Loading...</span>
  </div>


  <div class="key-upload-section card mb-3">
    <div class="card-body">
      <h5 class="card-title">Upravljanje Ključevima</h5>
      <div class="form-group mb-2">
        <label for="privateKeyFile">Privatni ključ (.pem, .key):</label>
        <input type="file" id="privateKeyFile" (change)="onPrivateKeyFileSelected($event)" accept=".pem,.key">
        <span *ngIf="privateKey" class="text-success ms-2">Privatni ključ učitan!</span>
        <span *ngIf="!privateKey" class="text-danger ms-2">Privatni ključ NIJE učitan!</span>
      </div>
      <div class="form-group">
        <p class="mb-0">
          <label>Javni ključ (vlasnika):</label>
          <span *ngIf="publicKey" class="text-success ms-2">Učitan sa servera!</span>
          <span *ngIf="!publicKey" class="text-danger ms-2">Nije učitan sa servera. Molimo sačekajte ili proverite sertifikat.</span>
        </p>
      </div>
    </div>
  </div>

  <button class="btn btn-primary mb-3" (click)="showCreateForm = !showCreateForm">
    {{ showCreateForm ? 'Sakrij formu' : 'Dodaj novu lozinku' }}
  </button>

  <div *ngIf="showCreateForm" class="password-form card mb-3">
    <div class="card-body">
      <h5 class="card-title">Nova Lozinka</h5>
      <form [formGroup]="passwordForm" (ngSubmit)="createPasswordEntry()">
        <div class="form-group mb-2">
          <label for="siteName">Naziv sajta:</label>
          <input type="text" id="siteName" formControlName="siteName" class="form-control">
          <div *ngIf="passwordForm.get('siteName')?.invalid && passwordForm.get('siteName')?.touched" class="text-danger">
            Naziv sajta je obavezan.
          </div>
        </div>
        <div class="form-group mb-2">
          <label for="username">Korisničko ime:</label>
          <input type="text" id="username" formControlName="username" class="form-control">
          <div *ngIf="passwordForm.get('username')?.invalid && passwordForm.get('username')?.touched" class="text-danger">
            Korisničko ime je obavezno.
          </div>
        </div>
        <div class="form-group mb-3">
          <label for="plainTextPassword">Lozinka (tekst):</label>
          <input type="password" id="plainTextPassword" formControlName="plainTextPassword" class="form-control">
          <div *ngIf="passwordForm.get('plainTextPassword')?.invalid && passwordForm.get('plainTextPassword')?.touched" class="text-danger">
            Lozinka je obavezna.
          </div>
        </div>
        <button type="submit" class="btn btn-success" [disabled]="passwordForm.invalid || !publicKey || isLoading">Kreiraj i Enkriptuj</button>
      </form>
    </div>
  </div>


  <h3>Moje Lozinke ({{ passwordEntries.length }})</h3>
  <ul class="list-group">
    <li *ngFor="let entry of passwordEntries" class="list-group-item d-flex justify-content-between align-items-center"
        [class.active]="selectedPasswordEntry?.id === entry.id"
        (click)="selectPasswordEntry(entry)">
      <span>{{ entry.siteName }} ({{ entry.username }})</span>
      <span *ngIf="!isOwnedByCurrentUser(entry)" class="badge bg-info ms-2">Podeljeno sa korisnikom</span>
    <span *ngIf="isOwnedByCurrentUser(entry)" class="badge bg-primary ms-2">Vlasnik</span>
      <div>
        <button  *ngIf="isOwnedByCurrentUser(entry)"  class="btn btn-danger btn-sm" (click)="deletePasswordEntry(entry.id!); $event.stopPropagation()">Obriši</button>
      </div>
    </li>
    <li *ngIf="passwordEntries.length === 0 && !isLoading" class="list-group-item text-muted">Nema sačuvanih lozinki.</li>
  </ul>

 
  <div *ngIf="selectedPasswordEntry" class="selected-password-details card mt-3">
    <div class="card-body">
      <h5 class="card-title">Detalji Lozinke: {{ selectedPasswordEntry.siteName }}</h5>
      <p><strong>Korisničko ime:</strong> {{ selectedPasswordEntry.username }}</p>
      <p><strong>Vlasnik:</strong> {{ selectedPasswordEntry.ownerUsername }}</p>
      <p><strong>Kreirano:</strong> {{ selectedPasswordEntry.createdAt | date:'short' }}</p>

      <button class="btn btn-info me-2" (click)="decryptSelectedPassword()" [disabled]="!privateKey || isLoading">Dekriptuj Lozinku</button>
      <div *ngIf="decryptedPassword" class="mt-2">
        <p><strong>Dešifrovana lozinka:</strong> <span class="badge bg-secondary">{{ decryptedPassword }}</span></p>
      </div>

      <hr>

     
      <button  *ngIf="isOwnedByCurrentUser(selectedPasswordEntry)"  class="btn btn-secondary mt-2" (click)="showShareForm = !showShareForm">
        {{ showShareForm ? 'Sakrij formu za deljenje' : 'Podeli lozinku' }}
      </button>

      <div *ngIf="showShareForm" class="share-form mt-3">
        <h6>Podeli sa drugim korisnikom</h6>
        <form [formGroup]="shareForm" (ngSubmit)="sharePasswordEntry()">
          <div class="form-group mb-2">
            <label for="sharedWithUserId">Email Korisnika:</label>
            <input type="text" id="sharedWithUserId" formControlName="sharedWithUserId" class="form-control">
            <div *ngIf="shareForm.get('sharedWithUserId')?.invalid && shareForm.get('sharedWithUserId')?.touched" class="text-danger">
              Molimo unesite validan email korisnika.
            </div>
          </div>
          <button type="submit" class="btn btn-primary" [disabled]="shareForm.invalid || !privateKey || isLoading">Podeli</button>
        </form>
      </div>
    </div>
  </div>
</div>